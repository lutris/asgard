#!/usr/bin/env bash

set -e
DOCKER_IMAGE=$1

if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
    # Find the top display number
    maxdisplay=$(cd /tmp/.X11-unix && for x in X*; do echo "${x#X}"; done | tail -1)
    # 1280x1024 seems to be the optimal res. 
    # For Xwayland it doesn't really matter, it can resize itself
    #Xephyr :$((maxdisplay + 1)) -screen 1280x1024 -fullscreen 2> /dev/null & Xprovider=Xephyr
    Xwayland -geometry 1280x1024 :$((maxdisplay + 1)) -fullscreen 2> /dev/null & Xprovider=Xwayland
    X_PID=$!
    export DISPLAY=:$((maxdisplay + 1))
    echo "PID of nexted X server: $X_PID"
fi

# This is needed because Xephyr and Xwayland don't close after the game does
# and for some reason every time new ossp-padsp process is created
# and never terminated, which after some time causes crackling.
# -9 is there bcs otherwise it doesn't want to die
cleanup(){
    echo "Performing cleanup..."
    if [ ! -z "$X_PID" ] && [ "$(ps -p "$X_PID" -o comm=)" = "$Xprovider" ]; then
        printf "Killing nested X server %s\n" "$Xprovider"
        kill "$X_PID"
    fi
    for pid in $(pidof ossp-padsp); do
        echo "Killing oss-padsp ($pid)"
        kill -9 "$pid"
    done
}

trap 'cleanup' EXIT

uid=$(id -u)
docker run \
    -it \
    -e DISPLAY="$DISPLAY" \
    --privileged \
    --network host \
    --device /dev/snd \
    --device /dev/dri \
    --group-add=audio \
    -v /etc/machine-id:/etc/machine-id \
    -v /var/lib/dbus:/var/lib/dbus \
    -e PULSE_SERVER=unix:"${XDG_RUNTIME_DIR}/pulse/native" \
    -v "${XDG_RUNTIME_DIR}/pulse/native:${XDG_RUNTIME_DIR}/pulse/native" \
    -v "${XDG_CONFIG_HOME:-$HOME/.config}/pulse/cookie":/home/loki/.config/pulse/cookie \
    --group-add "$(getent group audio | cut -d: -f3)" \
    -v "${XAUTHORITY:-$HOME/.Xauthority}:/home/loki/.Xauthority:rw" \
    -v "${XDG_DATA_HOME:-$HOME/.local/share}/loki:/home/loki/.loki:rw" \
    -v "${XDG_DATA_HOME:-$HOME/.local/share}/quake4:/home/loki/.quake4:rw" \
    -v "${XDG_DATA_HOME:-$HOME/.local/share}/hyperion:/home/loki/.hyperion:rw" \
    -v "/tmp/.X11-unix:/tmp/.X11-unix:rw" \
    -v "${XDG_RUNTIME_DIR}:/run/loki/$uid:rw" \
    -v "/media/cdrom:/cdrom" \
    --env=DISPLAY \
    --env=XDG_RUNTIME_DIR="/run/user/$uid" \
    "$DOCKER_IMAGE"
